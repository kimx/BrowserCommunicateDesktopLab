<!DOCTYPE html>
<html>
<head>
    <title>Web Socket:使用 WebSocketSharp</title>
    <meta charset="utf-8" />
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
</head>
<body>
    UgozWebSocketService  Connection State: <span id="status"></span>
    <div>
        <input type="text" id="txtData" /> <button type="button" id="btnSend">Send</button>
    </div>
    <br /><span id="accountName"></span>

    <script type="text/javascript">
        $(function () {
            function onMessage(message) {
                var pre = $("#accountName").html();
                $("#accountName").html(message + "<br/>" + pre);
            }


            function connect() {
                //var ws = new WebSocket('ws://localhost:1105');
            //    var ws = new WebSocket('ws://localhost:55688/scales');
                var ws = new WebSocket('ws://localhost:55688/scales');
                ws.binaryType = "arraybuffer";
                ws.onopen = function () {
                    console.log("Connected");
                    $("#status").html("Connected");
                };

                ws.onmessage = function (evt) {
                    console.log("Received")
                    console.log(evt);
                    //var message = new TextDecoder("utf-8").decode(evt.data);//arraybuffer
                    var message = evt.data;//string
                    onMessage(message);
                };

                ws.onclose = function (e) {
                    $("#status").html("Closed : Socket is closed. Reconnect will be attempted in 1 second." + new Date().toLocaleTimeString());
                    console.log('Socket is closed. Reconnect will be attempted in 1 second.', e.reason);
                    setTimeout(function () {
                        connect();
                    }, 1000);
                };

                ws.onerror = function (err) {
                    $("#status").html("Error");
                    console.error('Socket encountered error: ', err.message, 'Closing socket');
                    ws.close();
                };


                $("#btnSend").on("click", function () {
                    var value = $("#txtData").val();
                    ws.send(value);
                })

            }
            connect();


        })
    </script>
</body>
</html>
